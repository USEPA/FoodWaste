# -*- coding: utf-8 -*-
# Generated by Django 1.11.9 on 2018-05-10 14:12
from __future__ import unicode_literals

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('notebooks_tab', '0014_auto_20180509_2122'),
    ]

    reverse_email_sql = """
        CREATE OR REPLACE VIEW notebooks_tab_notebookstab_recent_emails as (
            with emails as (
                select row_number() over (partition by r.user_id order by r.email_last_sent desc nulls last) as email_order, * from notebooks_tab_notebookstab_reviews r
            )
            select row_number() OVER (ORDER BY user_id) AS id, id as review_id, nbtab_id, user_id, email_last_sent from emails where email_order = 1
        );
    """

    email_sql = """
        CREATE OR REPLACE VIEW notebooks_tab_notebookstab_recent_emails as (
            with emails as (
                select row_number() over (partition by sr.user_id order by sr.email_last_sent desc nulls last) as email_order, * from notebooks_tab_notebookstab_schedule_review sr
            )
            select row_number() OVER (ORDER BY user_id) AS id, id as review_id, nbtab_id, user_id, email_last_sent from emails where email_order = 1
        );
    """

    operations = [
        migrations.AddField(
            model_name='notebookstab_schedule_review',
            name='email_last_sent',
            field=models.DateField(blank=True, db_index=True, null=True),
        ),
        migrations.RunSQL(email_sql, reverse_sql=reverse_email_sql),
        migrations.RemoveField(
            model_name='notebookstab_reviews',
            name='email_last_sent',
        )
    ]
